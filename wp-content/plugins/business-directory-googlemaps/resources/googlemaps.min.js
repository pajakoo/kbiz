var wpbdp=window.wpbdp||{};!function($){var googlemaps=wpbdp.googlemaps=wpbdp.googlemaps||{};googlemaps._maps=[];googlemaps.listeners={map_created:[],map_rendered:[]};googlemaps.refresh_all=function(){$.each(googlemaps._maps,function(i,map){map.refresh()})};googlemaps.Map=function(htmlID,settings){this.MAP_TYPES={roadmap:google.maps.MapTypeId.ROADMAP,satellite:google.maps.MapTypeId.SATELLITE,hybrid:google.maps.MapTypeId.HYBRID,terrain:google.maps.MapTypeId.TERRAIN};this.$map=$("#"+htmlID);this.locations=[];this.settings=settings;"undefined"!=typeof this.settings.zoom_level&&"auto"!=this.settings.zoom_level&&(this.settings.zoom_level=parseInt(this.settings.zoom_level));this.settings.removeEmpty=!0;this.bounds=new google.maps.LatLngBounds;this.GoogleMap=new google.maps.Map(this.$map[0],{mapTypeId:this.MAP_TYPES[this.settings.map_type]});this.infoWindow=new google.maps.InfoWindow;this.oms=new OverlappingMarkerSpiderfier(this.GoogleMap,{markersWontMove:!0,markersWontHide:!0,keepSpiderfied:!0});this.rendered=!1;for(var i=0;i<googlemaps.listeners.map_created.length;i++)googlemaps.listeners.map_created[i](this);googlemaps._maps.push(this)};$.extend(googlemaps.Map.prototype,{_addMarker:function(place){if("undefined"!=typeof place&&place&&"undefined"!=typeof place.geolocation&&place.geolocation&&"undefined"!=typeof place.geolocation.lat&&place.geolocation.lat&&"undefined"!=typeof place.geolocation.lng&&place.geolocation.lng){var position=new google.maps.LatLng(place.geolocation.lat,place.geolocation.lng);this.bounds.extend(position);var marker=new google.maps.Marker({map:this.GoogleMap,position:position,animation:this.settings.animate_markers?google.maps.Animation.DROP:null});marker.descriptionHTML='<small><a href="'+place.url+'"><b>'+place.title+"</b></a><br />"+place.content.replace("\n","<br />")+"</small>";this.oms.addMarker(marker)}},setLocations:function(locations){this.locations=locations},fitContainer:function(stretch,enlarge){if(this.settings.auto_resize&&"auto"!==this.settings.map_size){var parent_width=this.$map.parent().innerWidth(),current_width=this.$map.outerWidth();parent_width<current_width?this.$map.width(parent_width-2):parent_width>=this.orig_width&&this.$map.width(map.orig_width-2);this.refresh()}},refresh:function(){if(this.$map.is(":visible"))if(this.rendered){this.$map.width(this.$map.parent().innerWidth()-2);google.maps.event.trigger(this.GoogleMap,"resize");this.GoogleMap.setCenter(this.bounds.getCenter())}else this.render()},render:function(){var map=this;this.orig_width=this.$map.width();var listingsContainer=this.$map.parent().siblings(".wpbdp-listings-list");if(0==listingsContainer.length)var listingsContainer=this.$map.parent().siblings().find("div.listings");"top"==this.settings.position&&this.$map.prependTo(listingsContainer);if(this.locations)for(var i=0;i<this.locations.length;i++)this._addMarker(this.locations[i]);this.oms.addListener("click",function(marker,event){map.infoWindow.setContent(marker.descriptionHTML);map.infoWindow.open(map.GoogleMap,marker)});this.oms.addListener("spiderfy",function(markers){map.infoWindow.close()});for(var i=0;i<googlemaps.listeners.map_rendered.length;i++)googlemaps.listeners.map_rendered[i](map);google.maps.event.addListenerOnce(this.GoogleMap,"idle",function(){map.settings.removeEmpty&&!map.locations&&map.$map.remove();1==map.locations.length?"auto"!=map.settings.zoom_level?map.GoogleMap.setZoom(map.settings.zoom_level):map.GoogleMap.setZoom(15):map.GoogleMap.fitBounds(map.bounds);map.GoogleMap.setCenter(map.bounds.getCenter())});this.rendered=!0;$(window).resize(function(){map.fitContainer(!0,!1)});map.fitContainer(!0,!1)}});googlemaps.DirectionsHandler=function(map,$form,$display){if(0!=$form.length&&map.settings.listingID&&1==map.locations.length){this._map=map;this._$form=$form;this._$display=null;this.from=null;this.to=[map.locations[0].geolocation.lat,map.locations[0].geolocation.lng];this.travelMode=null;this._working=!1;this._error="";var t=this;t._$form.find(".find-route-btn").click(function(e){e.preventDefault();t.startRouting()});t._$form.find('input[name="from_mode"]').change(function(e){"address"==$(this).val()?t._$form.find('input[name="from_address"]').show().focus():t._$form.find('input[name="from_address"]').hide()})}};$.extend(googlemaps.DirectionsHandler.prototype,{HTML_TEMPLATE:'<div id="wpbdp-map-directions-wrapper" style="display: none;"><div id="wpbdp-map-directions" class="cf"><div class="wpbdp-google-map route-map"></div><div class="directions-panel"></div></div></div>',TRAVEL_MODES:{driving:google.maps.TravelMode.DRIVING,cycling:google.maps.TravelMode.BICYCLING,transit:google.maps.TravelMode.TRANSIT,walking:google.maps.TravelMode.WALKING},error:function(msg){var t=this;"undefined"!=typeof msg&&msg||(msg="");t._error=msg;t._working=!1;msg&&alert(t._error);t._$form.find(".find-route-btn").prop("disabled",!1).val(WPBDP_googlemaps_directions_l10n.submit_normal)},startRouting:function(){var t=this;if(!t._working){t._working=!0;t._$form.find(".find-route-btn").prop("disabled",!0).val(WPBDP_googlemaps_directions_l10n.submit_working);$("#wpbdp-map-directions-wrapper").remove();t._$display=$(t.HTML_TEMPLATE).appendTo("body");var fromMode=t._$form.find('input[name="from_mode"]:checked').val(),address=$.trim(this._$form.find('input[name="from_address"]').val()),travelMode=t._$form.find('select[name="travel_mode"]').val();if("current"==fromMode||"address"==fromMode)if("address"!=fromMode||address)if("driving"==travelMode||"cycling"==travelMode||"walking"==travelMode||"transit"==travelMode){t.travelMode=travelMode;"current"==fromMode?t.geolocate():t.geocode(address)}else t.error();else t.error();else t.error()}},geolocate:function(){var t=this;t._working&&(navigator.geolocation?navigator.geolocation.getCurrentPosition(function(pos){t.from=[pos.coords.latitude,pos.coords.longitude];t.displayRoute()},function(err){t.error(err.message)}):t.error(WPBDP_googlemaps_directions_l10n.errors_no_route))},geocode:function(address){var t=this;if(t._working){"undefined"==typeof t._geocoderService&&(t._geocoderService=new google.maps.Geocoder);t._geocoderService.geocode({address:address},function(results,status_){if(google.maps.GeocoderStatus.OK===status_){var pos=results[0].geometry.location;t.from=[pos.lat(),pos.lng()];t.displayRoute()}else t.error(WPBDP_googlemaps_directions_l10n.errors_no_route)})}},displayRoute:function(){var t=this;if(t._working){var directionsDisplay,directionsService;directionsDisplay=new google.maps.DirectionsRenderer;directionsService=new google.maps.DirectionsService;var request={origin:new google.maps.LatLng(t.from[0],t.from[1]),destination:new google.maps.LatLng(t.to[0],t.to[1]),travelMode:t.TRAVEL_MODES[t.travelMode]};directionsService.route(request,function(res,status_){if(google.maps.DirectionsStatus.OK==status_){var mapOptions={zoom:7,center:new google.maps.LatLng(t.from[0],t.from[1]),mapTypeId:google.maps.MapTypeId.ROADMAP},map=new google.maps.Map(t._$display.find(".route-map").get(0),mapOptions);directionsDisplay.setMap(map);directionsDisplay.setPanel(t._$display.find(".directions-panel").get(0));directionsDisplay.setDirections(res);t._routeMap=map;t.showThickbox()}else t.error(WPBDP_googlemaps_directions_l10n.errors_no_route)})}},showThickbox:function(){var t=this;if(t._working){var width=Math.floor(.8*$(window).width())-5,height=Math.floor(.8*$(window).height())-5;t._$display.find(".route-map").width(.7*width+"px");t._$display.find(".route-map").height(height+"px");t._$display.find(".directions-panel").css("max-height",height+"px");var listingTitle=t._$form.find('input[name="listing_title"]').val(),title=WPBDP_googlemaps_directions_l10n["titles_"+t.travelMode].replace(/%s/g,listingTitle);$("#wpbdp-map-directions-wrapper").show();google.maps.event.trigger(t._routeMap,"resize");tb_show(title,"#TB_inline?width="+width+"&height="+height+"&inlineId=wpbdp-map-directions-wrapper");$("#wpbdp-map-directions-wrapper").remove();t._working=!1;t._$form.find(".find-route-btn").prop("disabled",!1).val(WPBDP_googlemaps_directions_l10n.submit_normal)}}})}(jQuery);